---
title: "Homework 5"
author: Yike Zhao
output: github_document
---

This is my solution to HW5.

```{r setup, include = FALSE}
library(tidyverse)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

Read in the data.

```{r}
homicide_df = 
  read_csv("homicide_data/homicide-data.csv") %>% 
  mutate(
    city_state = str_c(city, state, sep = "_"),
    resolved = case_when(
      disposition == "Closed without arrest" ~ "unsolved",
      disposition == "Open/No arrest"        ~ "unsolved",
      disposition == "Closed by arrest"      ~ "solved",
    )
  ) %>% 
  select(city_state, resolved) %>% 
  filter(city_state != "Tulsa_AL")
```


Let's look at this a bit

```{r}
aggregate_df = 
  homicide_df %>% 
  group_by(city_state) %>% 
  summarize(
    hom_total = n(),
    hom_unsolved = sum(resolved == "unsolved")
  )
```

Can I do a prop test for a single city?

```{r}
prop.test(
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_unsolved), 
  aggregate_df %>% filter(city_state == "Baltimore_MD") %>% pull(hom_total)) %>% 
  broom::tidy()
```

Try to iterate ........

```{r}
results_df = 
  aggregate_df %>% 
  mutate(
    prop_tests = map2(.x = hom_unsolved, .y = hom_total, ~prop.test(x = .x, n = .y)),
    tidy_tests = map(.x = prop_tests, ~broom::tidy(.x))
  ) %>% 
  select(-prop_tests) %>% 
  unnest(tidy_tests) %>% 
  select(city_state, estimate, conf.low, conf.high)
```



```{r}
results_df %>% 
  mutate(city_state = fct_reorder(city_state, estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```



## Problem 2

import one dataset 

```{r}
data_1 = read_csv("lda_data/con_01.csv")
```

Iterate over file names and tidy the result dataframe

```{r, error = TRUE}
path_df = 
  tibble(
    path = list.files("lda_data"),
  ) %>% 
  mutate(
    path = str_c("lda_data/", path)
  ) 

obs_df =
  path_df %>% 
  mutate(
    obs = map(.x = path, ~read_csv(.x))
  ) %>% 
  unnest(obs) %>% 
  mutate(
    path = str_replace(path, "lda_data/", ""),
    path = str_replace(path, ".csv", "")
  ) %>% 
  tibble::rowid_to_column("index") %>% 
  separate(path, c("arms", "id")) %>% 
  pivot_longer(
    week_1:week_8,
    names_to = "week",
    names_prefix = "week_",
    values_to = "observations"
  )
```

Make a spaghetti plot showing observations on each subject over time.

```{r}
obs_df %>% 
  ggplot(aes(x = week, y = observations, color = arms, group = index)) + 
  geom_smooth(se = FALSE) +
  labs(
    title = "Observations of Each Object Over 8 Weeks",
    x = "Week",
    y = "Observations",
    caption ="Data from the lda package"
  ) 
```

From the plot we can see the observation value tend to be higher in the experiment groups than the control groups. While the level of the observation values are more stable across the 8 weeks for objects in the control group, an increasing trend is observed in the objects of the experiment group.



